# Row Level Security (RLS) Policies Documentation

**Last Updated:** January 2025

This document contains all Row Level Security (RLS) policies currently active in the promptreviews database.

## Overview

Row Level Security (RLS) is enabled on all tables to ensure data isolation and security. Each table has specific policies that control what operations users can perform based on their authentication status and ownership of the data.

## Policy Definitions

| schemaname | tablename          | policyname                                                  | permissive | roles           | cmd    | qual                                                                                                                      | with_check                                                                                                             |
| ---------- | ------------------ | ----------------------------------------------------------- | ---------- | --------------- | ------ | ------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------- |
| public     | account_users      | Users can link themselves to accounts                       | PERMISSIVE | {authenticated} | INSERT | null                                                                                                                      | (auth.uid() = user_id)                                                                                                 |
| public     | accounts           | Service role can create accounts                            | PERMISSIVE | {service_role}  | INSERT | null                                                                                                                      | true                                                                                                                   |
| public     | accounts           | Users can insert their own account                          | PERMISSIVE | {authenticated} | INSERT | null                                                                                                                      | (auth.uid() = id)                                                                                                      |
| public     | accounts           | Users can update their own account                          | PERMISSIVE | {authenticated} | UPDATE | (auth.uid() = id)                                                                                                         | (auth.uid() = id)                                                                                                      |
| public     | accounts           | Users can view their own account                            | PERMISSIVE | {authenticated} | SELECT | (id = auth.uid())                                                                                                         | null                                                                                                                   |
| public     | admins             | Admins can create admins                                    | PERMISSIVE | {public}        | INSERT | null                                                                                                                      | (EXISTS ( SELECT 1 FROM admins admins_1 WHERE (admins_1.account_id = auth.uid())))                                |
| public     | admins             | Admins can delete admins                                    | PERMISSIVE | {public}        | DELETE | (EXISTS ( SELECT 1 FROM admins admins_1 WHERE (admins_1.account_id = auth.uid())))                                   | null                                                                                                                   |
| public     | admins             | Admins can update admins                                    | PERMISSIVE | {public}        | UPDATE | (EXISTS ( SELECT 1 FROM admins admins_1 WHERE (admins_1.account_id = auth.uid())))                                   | null                                                                                                                   |
| public     | admins             | Allow admin checking                                        | PERMISSIVE | {public}        | SELECT | true                                                                                                                      | null                                                                                                                   |
| public     | admins             | Allow admin management                                      | PERMISSIVE | {public}        | ALL    | (account_id = auth.uid())                                                                                                 | null                                                                                                                   |
| public     | analytics_events   | Allow public insert                                         | PERMISSIVE | {anon}          | INSERT | null                                                                                                                      | true                                                                                                                   |
| public     | analytics_events   | Allow service_role insert                                   | PERMISSIVE | {service_role}  | INSERT | null                                                                                                                      | true                                                                                                                   |
| public     | analytics_events   | Users can insert their own events                           | PERMISSIVE | {authenticated} | INSERT | null                                                                                                                      | true                                                                                                                   |
| public     | analytics_events   | Users can view their own events                             | PERMISSIVE | {authenticated} | SELECT | true                                                                                                                      | null                                                                                                                   |
| public     | announcements      | Admins can create announcements                             | PERMISSIVE | {public}        | INSERT | null                                                                                                                      | (EXISTS ( SELECT 1 FROM admins WHERE (admins.account_id = auth.uid())))                                           |
| public     | announcements      | Admins can delete announcements                             | PERMISSIVE | {public}        | DELETE | (EXISTS ( SELECT 1 FROM admins WHERE (admins.account_id = auth.uid())))                                              | null                                                                                                                   |
| public     | announcements      | Admins can update announcements                             | PERMISSIVE | {public}        | UPDATE | (EXISTS ( SELECT 1 FROM admins WHERE (admins.account_id = auth.uid())))                                              | null                                                                                                                   |
| public     | announcements      | Admins can view all announcements                           | PERMISSIVE | {public}        | SELECT | (EXISTS ( SELECT 1 FROM admins WHERE (admins.account_id = auth.uid())))                                              | null                                                                                                                   |
| public     | announcements      | Allow admin management of announcements                     | PERMISSIVE | {public}        | ALL    | (EXISTS ( SELECT 1 FROM admins WHERE ((admins.account_id = auth.uid()) AND (admins.id = announcements.created_by)))) | null                                                                                                                   |
| public     | announcements      | Allow public read access to active announcements            | PERMISSIVE | {public}        | SELECT | (is_active = true)                                                                                                        | null                                                                                                                   |
| public     | announcements      | Everyone can view active announcements                      | PERMISSIVE | {public}        | SELECT | (is_active = true)                                                                                                        | null                                                                                                                   |
| public     | businesses         | Public read access                                          | PERMISSIVE | {public}        | SELECT | true                                                                                                                      | null                                                                                                                   |
| public     | businesses         | Users can create their own business                         | PERMISSIVE | {public}        | INSERT | null                                                                                                                      | (account_id = auth.uid())                                                                                              |
| public     | businesses         | Users can delete their own business                         | PERMISSIVE | {public}        | DELETE | (account_id = auth.uid())                                                                                                 | null                                                                                                                   |
| public     | businesses         | Users can update their own business                         | PERMISSIVE | {public}        | UPDATE | (account_id = auth.uid())                                                                                                 | null                                                                                                                   |
| public     | businesses         | Users can view their own business                           | PERMISSIVE | {public}        | SELECT | (account_id = auth.uid())                                                                                                 | null                                                                                                                   |
| public     | contacts           | Users can delete their own contacts                         | PERMISSIVE | {public}        | DELETE | (auth.uid() = account_id)                                                                                                 | null                                                                                                                   |
| public     | contacts           | Users can insert their own contacts                         | PERMISSIVE | {public}        | INSERT | null                                                                                                                      | (auth.uid() = account_id)                                                                                              |
| public     | contacts           | Users can update their own contacts                         | PERMISSIVE | {public}        | UPDATE | (auth.uid() = account_id)                                                                                                 | null                                                                                                                   |
| public     | contacts           | Users can view their own contacts                           | PERMISSIVE | {public}        | SELECT | (auth.uid() = account_id)                                                                                                 | null                                                                                                                   |
| public     | debug_errors       | Allow insert for authenticated                              | PERMISSIVE | {authenticated} | INSERT | null                                                                                                                      | true                                                                                                                   |
| public     | debug_errors       | Allow insert for service_role                               | PERMISSIVE | {service_role}  | INSERT | null                                                                                                                      | true                                                                                                                   |
| public     | debug_errors       | Allow update for authenticated                              | PERMISSIVE | {authenticated} | UPDATE | true                                                                                                                      | true                                                                                                                   |
| public     | debug_errors       | Allow update for service_role                               | PERMISSIVE | {service_role}  | UPDATE | true                                                                                                                      | true                                                                                                                   |
| public     | feedback           | Admins can update feedback                                  | PERMISSIVE | {public}        | UPDATE | (EXISTS ( SELECT 1 FROM admins WHERE (feedback.user_id = auth.uid())))                                               | null                                                                                                                   |
| public     | feedback           | Admins can view all feedback                                | PERMISSIVE | {public}        | SELECT | (EXISTS ( SELECT 1 FROM admins WHERE (feedback.user_id = auth.uid())))                                               | null                                                                                                                   |
| public     | feedback           | Service role can insert feedback                            | PERMISSIVE | {service_role}  | INSERT | null                                                                                                                      | true                                                                                                                   |
| public     | feedback           | Service role can update feedback                            | PERMISSIVE | {service_role}  | UPDATE | true                                                                                                                      | null                                                                                                                   |
| public     | feedback           | Users can insert own feedback                               | PERMISSIVE | {public}        | INSERT | null                                                                                                                      | (auth.uid() = user_id)                                                                                                 |
| public     | feedback           | Users can view own feedback                                 | PERMISSIVE | {public}        | SELECT | (auth.uid() = user_id)                                                                                                    | null                                                                                                                   |
| storage    | objects            | Allow authenticated users to update and read logos 1peuqw_0 | PERMISSIVE | {authenticated} | UPDATE | (bucket_id = 'logos'::text)                                                                                               | null                                                                                                                   |
| storage    | objects            | Allow authenticated users to upload and read logos          | PERMISSIVE | {authenticated} | ALL    | (bucket_id = 'logos'::text)                                                                                               | (bucket_id = 'logos'::text)                                                                                            |
| storage    | objects            | Authenticated upload for products                           | PERMISSIVE | {public}        | INSERT | null                                                                                                                      | ((auth.role() = 'authenticated'::text) AND (bucket_id = 'products'::text))                                             |
| storage    | objects            | Authenticated users can upload and read logos               | PERMISSIVE | {authenticated} | ALL    | (bucket_id = 'logos'::text)                                                                                               | (bucket_id = 'logos'::text)                                                                                            |
| storage    | objects            | Authenticated users can upload logos                        | PERMISSIVE | {public}        | INSERT | null                                                                                                                      | ((bucket_id = 'logos'::text) AND (auth.role() = 'authenticated'::text))                                                |
| storage    | objects            | Authenticated users can upload product photos               | PERMISSIVE | {public}        | INSERT | null                                                                                                                      | ((bucket_id = 'products'::text) AND (auth.role() = 'authenticated'::text))                                             |
| storage    | objects            | Authenticated users can upload/download/udate etc 1eyt5yn_0 | PERMISSIVE | {public}        | SELECT | (bucket_id = 'testimonial-photos'::text)                                                                                  | null                                                                                                                   |
| storage    | objects            | Authenticated users can upload/download/udate etc 1eyt5yn_1 | PERMISSIVE | {public}        | INSERT | null                                                                                                                      | (bucket_id = 'testimonial-photos'::text)                                                                               |
| storage    | objects            | Authenticated users can upload/download/udate etc 1eyt5yn_2 | PERMISSIVE | {public}        | UPDATE | (bucket_id = 'testimonial-photos'::text)                                                                                  | null                                                                                                                   |
| storage    | objects            | Owner can update their own product photos                   | PERMISSIVE | {public}        | UPDATE | ((auth.role() = 'authenticated'::text) AND (bucket_id = 'products'::text) AND (owner = auth.uid()))                       | null                                                                                                                   |
| storage    | objects            | Public read access                                          | PERMISSIVE | {public}        | SELECT | (bucket_id = 'products'::text)                                                                                            | null                                                                                                                   |
| storage    | objects            | Public read access for business-logos                       | PERMISSIVE | {public}        | SELECT | (bucket_id = 'business-logos'::text)                                                                                      | null                                                                                                                   |
| storage    | objects            | Public read access for logos                                | PERMISSIVE | {public}        | SELECT | (bucket_id = 'logos'::text)                                                                                               | null                                                                                                                   |
| storage    | objects            | Public read access for products                             | PERMISSIVE | {public}        | SELECT | (bucket_id = 'products'::text)                                                                                            | null                                                                                                                   |
| storage    | objects            | allow authenticated users to delete logo 1peuqw_0           | PERMISSIVE | {authenticated} | DELETE | (bucket_id = 'logos'::text)                                                                                               | null                                                                                                                   |
| public     | prompt_pages       | Public read access                                          | PERMISSIVE | {public}        | SELECT | true                                                                                                                      | null                                                                                                                   |
| public     | prompt_pages       | Users can delete their own prompt pages                     | PERMISSIVE | {authenticated} | DELETE | (auth.uid() = account_id)                                                                                                 | null                                                                                                                   |
| public     | prompt_pages       | Users can insert their own prompt pages                     | PERMISSIVE | {authenticated} | INSERT | null                                                                                                                      | (auth.uid() = account_id)                                                                                              |
| public     | prompt_pages       | Users can update their own prompt pages                     | PERMISSIVE | {authenticated} | UPDATE | (auth.uid() = account_id)                                                                                                 | (auth.uid() = account_id)                                                                                              |
| public     | prompt_pages       | Users can view their own prompt pages                       | PERMISSIVE | {authenticated} | SELECT | (auth.uid() = account_id)                                                                                                 | null                                                                                                                   |
| public     | quotes             | Admins can create quotes                                    | PERMISSIVE | {public}        | INSERT | null                                                                                                                      | (EXISTS ( SELECT 1 FROM admins WHERE (admins.account_id = auth.uid())))                                           |
| public     | quotes             | Admins can delete quotes                                    | PERMISSIVE | {public}        | DELETE | (EXISTS ( SELECT 1 FROM admins WHERE (admins.account_id = auth.uid())))                                              | null                                                                                                                   |
| public     | quotes             | Admins can update quotes                                    | PERMISSIVE | {public}        | UPDATE | (EXISTS ( SELECT 1 FROM admins WHERE (admins.account_id = auth.uid())))                                              | null                                                                                                                   |
| public     | quotes             | Admins can view all quotes                                  | PERMISSIVE | {public}        | SELECT | (EXISTS ( SELECT 1 FROM admins WHERE (admins.account_id = auth.uid())))                                              | null                                                                                                                   |
| public     | quotes             | Allow admin management of quotes                            | PERMISSIVE | {public}        | ALL    | (EXISTS ( SELECT 1 FROM admins WHERE ((admins.account_id = auth.uid()) AND (admins.id = quotes.created_by))))        | null                                                                                                                   |
| public     | quotes             | Allow public read access to active quotes                   | PERMISSIVE | {public}        | SELECT | (is_active = true)                                                                                                        | null                                                                                                                   |
| public     | quotes             | Everyone can view active quotes                             | PERMISSIVE | {public}        | SELECT | (is_active = true)                                                                                                        | null                                                                                                                   |
| public     | review_submissions | Allow all for dev                                           | PERMISSIVE | {public}        | ALL    | true                                                                                                                      | null                                                                                                                   |
| public     | review_submissions | Allow insert for authenticated users                        | PERMISSIVE | {authenticated} | INSERT | null                                                                                                                      | true                                                                                                                   |
| public     | review_submissions | Allow public insert                                         | PERMISSIVE | {anon}          | INSERT | null                                                                                                                      | true                                                                                                                   |
| public     | review_submissions | Allow select for authenticated users                        | PERMISSIVE | {authenticated} | SELECT | true                                                                                                                      | null                                                                                                                   |
| public     | widgets            | Allow delete for authenticated users                        | PERMISSIVE | {authenticated} | DELETE | (EXISTS ( SELECT 1 FROM accounts WHERE ((accounts.id = widgets.account_id) AND (accounts.user_id = auth.uid()))))    | null                                                                                                                   |
| public     | widgets            | Allow insert for authenticated users                        | PERMISSIVE | {authenticated} | INSERT | null                                                                                                                      | (EXISTS ( SELECT 1 FROM accounts WHERE ((accounts.id = widgets.account_id) AND (accounts.user_id = auth.uid())))) |
| public     | widgets            | Allow public read access                                    | PERMISSIVE | {anon}          | SELECT | true                                                                                                                      | null                                                                                                                   |
| public     | widgets            | Allow select for authenticated users                        | PERMISSIVE | {authenticated} | SELECT | (EXISTS ( SELECT 1 FROM accounts WHERE ((accounts.id = widgets.account_id) AND (accounts.user_id = auth.uid()))))    | null                                                                                                                   |
| public     | widgets            | Allow update for authenticated users                        | PERMISSIVE | {authenticated} | UPDATE | (EXISTS ( SELECT 1 FROM accounts WHERE ((accounts.id = widgets.account_id) AND (accounts.user_id = auth.uid()))))    | (EXISTS ( SELECT 1 FROM accounts WHERE ((accounts.id = widgets.account_id) AND (accounts.user_id = auth.uid())))) |

## Missing Policies

**IMPORTANT:** The following tables currently have RLS enabled but NO policies defined, which blocks all operations:

- `widget_reviews` - **FIXED** in migration `0040_fix_widget_reviews_rls.sql`

## Policy Categories

### User-Owned Data
- Users can only access data they own (via `account_id` or `user_id` relationships)
- Examples: businesses, contacts, prompt_pages, widgets

### Admin-Only Data
- Only users with admin privileges can access
- Examples: announcements, quotes, feedback management

### Public Data
- Anyone can read, but only authenticated users can modify
- Examples: widgets (public read), prompt_pages (public read)

### Service Role Data
- Only the service role can access
- Examples: analytics_events, debug_errors

## Troubleshooting

### Common RLS Issues

1. **Error 42501**: "new row violates row-level security policy"
   - **Cause**: Table has RLS enabled but no policies defined
   - **Solution**: Add appropriate RLS policies for the table

2. **Empty results from queries**
   - **Cause**: RLS policies are too restrictive
   - **Solution**: Check policy conditions and ensure user has proper permissions

3. **Authentication required errors**
   - **Cause**: Policy requires authenticated user but request is anonymous
   - **Solution**: Ensure user is logged in or add anonymous policies

### Debugging RLS

To debug RLS issues, run this query to see all policies for a specific table:

```sql
SELECT
  policyname,
  permissive,
  roles,
  cmd,
  qual,
  with_check
FROM pg_policies
WHERE tablename = 'your_table_name';
```

## Recent Changes

- **January 2025**: Added RLS policies for `widget_reviews` table to fix permission issues
- **Previous**: Various RLS fixes for admins, feedback, and other tables 